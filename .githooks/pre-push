#!/bin/bash
# Git Hook: Pre-Push
# Este script √© executado AUTOMATICAMENTE antes de cada 'git push'
# Ele cria um backup do banco de dados e inclui no push

echo ""
echo "üîÑ Criando backup autom√°tico do banco de dados..."
echo ""

# Executar o backup
npm run db:backup --silent

# Verificar se o backup foi criado
LATEST_BACKUP=$(ls -t backups/velostock_backup_*.sql 2>/dev/null | head -n 1)

if [ -n "$LATEST_BACKUP" ]; then
    echo ""
    echo "‚úÖ Backup criado: $LATEST_BACKUP"
    
    # Adicionar o backup ao git
    git add "$LATEST_BACKUP"
    
    # Verificar se h√° mudan√ßas para commitar
    if git diff --cached --quiet; then
        echo "‚ÑπÔ∏è  Backup j√° estava versionado"
    else
        # Fazer commit do backup
        TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
        git commit -m "üóÑÔ∏è Backup autom√°tico do banco de dados - $TIMESTAMP" --no-verify
        echo "‚úÖ Backup commitado automaticamente"
    fi
    
    echo ""
    echo "üì§ Continuando com o push..."
    echo ""
else
    echo "‚ö†Ô∏è  N√£o foi poss√≠vel criar o backup, mas o push continuar√°"
    echo ""
fi

# Permitir que o push continue
exit 0
